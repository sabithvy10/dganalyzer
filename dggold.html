<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Gold SIP Tracker with AI</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    /* STYLES */
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      padding-top: 70px;
      color: #333;
      text-align: center;
      transition: background 0.5s ease;
      margin: 0;
      background-color: #f5f7fa; /* Fallback background */
    }
    .dark-mode { background: #1a1a1a; color: #eee; }
    .dark-mode h1, .dark-mode .modal-content { color: #ddd; }
    .dark-mode .manual-container, .dark-mode .container { background: rgba(44, 44, 44, 0.85); }
    .dark-mode .countdown { color: #bbb; }

    /* --- ANIMATED BACKGROUND STYLES --- */
    .animated-background {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: -1;
        background: linear-gradient(45deg, #89253e, #3a6186);
        transition: background 1s ease;
    }
    .animated-background.app-view {
        background: linear-gradient(45deg, #2193b0, #6dd5ed);
    }
    .dark-mode .animated-background.app-view {
        background: linear-gradient(45deg, #0f2027, #203a43, #2c5364);
    }
    .shape {
        position: absolute;
        list-style: none;
        background: rgba(255, 255, 255, 0.1);
        animation: float 25s linear infinite;
        bottom: -150px;
    }
    .shape:nth-child(1){ left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
    .shape:nth-child(2){ left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
    .shape:nth-child(3){ left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
    .shape:nth-child(4){ left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
    .shape:nth-child(5){ left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
    .shape:nth-child(6){ left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
    .shape:nth-child(7){ left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
    .shape:nth-child(8){ left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
    .shape:nth-child(9){ left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
    .shape:nth-child(10){ left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }

    @keyframes float {
        0%{ transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; }
        100%{ transform: translateY(-120vh) rotate(720deg); opacity: 0; border-radius: 50%; }
    }

    /* --- AUTH & SETUP MODAL STYLES --- */
    #auth-modal, #setup-modal, #forgot-password-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.5s;
        background: transparent;
    }
    .auth-flip-container {
        perspective: 1000px;
        width: 90%;
        max-width: 400px;
    }
    .auth-flipper {
        position: relative;
        width: 100%;
        height: 580px; /* Increased height for new button */
        transition: transform 0.8s;
        transform-style: preserve-3d;
    }
    .auth-flip-container.is-flipped .auth-flipper {
        transform: rotateY(180deg);
    }
    .auth-container, .glass-container {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 40px;
        text-align: center;
        color: #fff;
        box-sizing: border-box;
    }
    #login-view, #signup-view {
        position: absolute;
        width: 100%; height: 100%;
        backface-visibility: hidden;
    }
    #signup-view {
        transform: rotateY(180deg);
    }
    .auth-container h2, .glass-container h2 { margin-top: 0; font-weight: 300; }
    .input-group { position: relative; margin-bottom: 20px; }
    .auth-container input, .glass-container input {
        width: 100%;
        padding: 12px 12px 12px 40px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        font-size: 1em;
        background: transparent;
        color: #fff;
        box-sizing: border-box;
        transition: all 0.3s ease;
    }
    .auth-container input:focus, .glass-container input:focus {
        border-color: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    }
    .auth-container input::placeholder, .glass-container input::placeholder { color: rgba(255, 255, 255, 0.7); }
    .input-group i { position: absolute; left: 15px; top: 14px; color: #fff; }
    .auth-container button, .glass-container button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(45deg, #89253e, #3a6186);
        color: #fff;
        font-size: 1.1em;
        cursor: pointer;
        transition: transform 0.2s;
        margin-top: 10px;
    }
    .auth-container button:hover, .glass-container button:hover { transform: scale(1.05); }
    .auth-toggle-link { color: #fff; cursor: pointer; margin-top: 15px; text-decoration: underline; display: inline-block; }
    .error-message { color: #ffcdd2; margin-bottom: 15px; min-height: 1.2em; }
    .success-message { color: #c8e6c9; margin-bottom: 15px; }
    #resend-verification-btn { background: #6c757d; margin-top: 10px; }
    #recaptcha-container { margin: 20px auto; }


    /* Header */
    .header {
        position: fixed; top: 0; left: 0; width: 100%; height: 60px;
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 20px; background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px); box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000; box-sizing: border-box;
    }
    .dark-mode .header { background: rgba(26, 26, 26, 0.8); }
    #menu-toggle { font-size: 2em; cursor: pointer; }
    .header-right { display: flex; align-items: center; gap: 20px; }
    .clock { font-size: 1em; font-weight: bold; }
    .theme-toggle { cursor: pointer; font-size: 1.5em; }

    /* Sidebar Menu */
    #side-menu {
        position: fixed; top: 0; left: -300px; width: 280px; height: 100%;
        background: #fff; box-shadow: 2px 0 15px rgba(0,0,0,0.2);
        z-index: 1001; transition: left 0.3s ease-in-out; padding-top: 60px;
    }
    #side-menu.open { left: 0; }
    .dark-mode #side-menu { background: #2c2c2c; }
    #side-menu ul { list-style: none; padding: 20px; margin: 0; }
    #side-menu ul li { padding: 15px; font-size: 1.2em; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
    .dark-mode #side-menu ul li { border-bottom-color: #444; }
    #side-menu ul li:hover { background: #f9f9f9; }
    .dark-mode #side-menu ul li:hover { background: #3a3a3a; }

    /* General Modal Styles */
    .modal {
        display: none; position: fixed; z-index: 1002; left: 0; top: 0;
        width: 100%; height: 100%; overflow: auto;
        background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s;
    }
    .modal-content {
        background-color: #fefefe; margin: 10% auto; padding: 20px;
        border-radius: 15px; width: 90%; max-width: 600px; position: relative;
    }
    .dark-mode .modal-content { background-color: #2c2c2c; }
    .close-button {
        color: #aaa; position: absolute; top: 10px; right: 20px;
        font-size: 28px; font-weight: bold; cursor: pointer;
    }
    .close-button:hover { color: #555; }
    .dark-mode .close-button { color: #888; }
    .dark-mode .close-button:hover { color: #ccc; }

    /* Transaction & About List Styles */
    #transaction-list, #about-content { max-height: 400px; overflow-y: auto; text-align: left; }
    .transaction-item {
        padding: 15px; border-bottom: 1px solid #eee; display: flex;
        justify-content: space-between; align-items: center;
    }
    .dark-mode .transaction-item { border-bottom-color: #444; }
    .transaction-item div:first-child { text-align: left; }
    .transaction-item .amount { font-weight: bold; font-size: 1.1em; }
    .transaction-item .date { color: #777; font-size: 0.9em; }
    .dark-mode .transaction-item .date { color: #aaa; }
    .transaction-item .status { font-weight: bold; }
    .status.success { color: #28a745; }
    .status.failed { color: #dc3545; }

    /* --- OLDER GREEN BUTTON STYLE --- */
    .app-button {
        padding: 12px 24px; border: none;
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white; border-radius: 10px; cursor: pointer;
        margin: 10px 5px; font-size: 1em;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }
    .app-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }
    .ai-button {
        background: linear-gradient(45deg, #6a11cb, #2575fc);
        box-shadow: 0 4px 15px rgba(106, 17, 203, 0.3);
    }
    .ai-button:hover {
        box-shadow: 0 6px 20px rgba(106, 17, 203, 0.4);
    }

    /* Other styles */
    #daily-change { font-size: 1.1em; margin-left: 10px; font-weight: bold; }
    .profit { color: #28a745; }
    .loss { color: #dc3545; }
    h1 { font-size: 2em; color: #444; margin-bottom: 10px; }
    .highlight { color: #28a745; font-weight: bold; font-size: 1.2em; }
    .dark-mode .highlight { color: #32cd32; }
    .container, .manual-container {
      background: rgba(255, 255, 255, 0.85); /* Made slightly transparent */
      backdrop-filter: blur(5px);
      padding: 20px; border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); display: inline-block;
      animation: fadeIn 1s ease-in-out; margin-top: 20px; width: 90%;
      max-width: 500px; box-sizing: border-box;
    }
    .app-content { display: none; } /* Hide main content by default */
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
  <div class="animated-background">
      <div class="shape"></div><div class="shape"></div><div class="shape"></div>
      <div class="shape"></div><div class="shape"></div><div class="shape"></div>
      <div class="shape"></div><div class="shape"></div><div class="shape"></div>
      <div class="shape"></div>
  </div>

  <!-- AUTHENTICATION MODAL -->
  <div id="auth-modal" class="modal" style="display: flex;">
      <div class="auth-flip-container">
          <div class="auth-flipper">
              <div id="login-view">
                  <div class="auth-container">
                      <h2>Welcome Back!</h2>
                      <p id="login-error" class="error-message"></p>
                      <p id="login-success" class="success-message"></p>
                      <div id="email-login-fields">
                          <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="login-email" placeholder="Email"></div>
                          <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="login-password" placeholder="Password"></div>
                          <button onclick="handleLogin()">Login with Email</button>
                      </div>
                      <div id="phone-login-fields" style="display: none;">
                          <div class="input-group"><i class="fas fa-phone"></i><input type="tel" id="phone-number" placeholder="+91 12345 67890"></div>
                          <button onclick="sendOtp()">Send OTP</button>
                          <div id="recaptcha-container"></div>
                          <div class="input-group" id="otp-group" style="display: none;"><i class="fas fa-key"></i><input type="number" id="otp" placeholder="Enter OTP"></div>
                          <button id="verify-otp-btn" style="display: none;" onclick="verifyOtp()">Verify OTP</button>
                      </div>
                      <button id="resend-verification-btn" style="display:none;" onclick="handleResendVerification()">Resend Verification Email</button>
                      <p class="auth-toggle-link" onclick="togglePhoneLogin(this)">Sign in with Phone</p>
                      <p class="auth-toggle-link" onclick="openForgotPassword()">Forgot Password?</p>
                      <p class="auth-toggle-link" onclick="toggleAuthView(false)">Don't have an account? Sign Up</p>
                  </div>
              </div>
              <div id="signup-view">
                  <div class="auth-container">
                      <h2>Create Account</h2>
                      <p id="signup-error" class="error-message"></p>
                      <div class="input-group"><i class="fas fa-user"></i><input type="text" id="signup-name" placeholder="Your Name"></div>
                      <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="signup-email" placeholder="Email"></div>
                      <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="signup-password" placeholder="Password"></div>
                      <button id="signup-btn" onclick="handleSignup()">Sign Up</button>
                      <p class="auth-toggle-link" onclick="toggleAuthView(true)">Already have an account? Login</p>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- FORGOT PASSWORD MODAL -->
  <div id="forgot-password-modal" class="modal">
    <div class="glass-container" style="position:relative; height: auto; max-width: 400px; width: 90%;">
      <h2>Reset Password</h2>
      <p>Enter your email and we'll send a reset link.</p>
      <p id="reset-error" class="error-message"></p>
      <p id="reset-success" class="success-message"></p>
      <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="reset-email" placeholder="Your Email Address"></div>
      <button onclick="handleForgotPassword()">Send Reset Link</button>
      <p class="auth-toggle-link" onclick="closeForgotPassword()">Back to Login</p>
    </div>
  </div>

  <!-- INITIAL SETUP MODAL -->
  <div id="setup-modal" class="modal">
    <div class="glass-container" style="position:relative; height: auto; max-width: 400px; width: 90%;">
      <h2>Welcome! Let's get you set up.</h2>
      <p>Enter your current investment details to get started.</p>
      <div class="input-group"><i class="fas fa-wallet"></i><input type="number" id="initial-balance" placeholder="Current Balance (₹)"></div>
      <div class="input-group"><i class="fas fa-calendar-day"></i><input type="number" id="initial-sip" placeholder="Daily SIP Amount (₹)"></div>
      <button onclick="handleInitialSetup()">Save and Start Tracking</button>
    </div>
  </div>

  <!-- MAIN APP CONTENT (Initially Hidden) -->
  <div id="app-content" class="app-content">
    <div class="header">
      <div id="menu-toggle" onclick="toggleMenu()">☰</div>
      <div class="header-right">
        <div class="clock" id="clock"></div>
        <div class="theme-toggle" onclick="toggleTheme()">🌓</div>
      </div>
    </div>

    <div id="side-menu">
      <ul>
        <li onclick="openTransactions()">📜 Transactions</li>
        <li onclick="openAbout()">ℹ️ About & FAQ</li>
        <li onclick="openContact()">📞 Contact</li>
        <li onclick="handleLogout()">🚪 Logout</li>
      </ul>
    </div>

    <h1 id="welcome-message"></h1>

    <div class="container">
      <h2>📈 Digital Gold SIP Tracker</h2>
      <div id="goldRateDisplay" class="gold-rate-display"></div>
      <button class="app-button" onclick="redirectToGoldSite()">🔗 View Live Gold Rate</button>
      <button class="app-button" onclick="applyManualGoldRate()">✍️ Apply Manual Rate</button>
      <div class="highlight balance-animated" id="daily-sip-display"></div>
      <div class="menu">
        <label for="targetDate">📅 Select a Future Date:</label>
        <input type="date" id="targetDate" class="calendar-input" placeholder="Select a date...">
        <button class="app-button" onclick="calculateGrowthFromDate()">📊 Show Forecast</button>
      </div>
      <div class="menu">
        <label for="targetGoldGrams">🥇 Target Gold (grams):</label>
        <input type="number" id="targetGoldGrams" placeholder="e.g., 1" value="1">
        <button class="app-button" onclick="calculateToReachTargetGrams()">🏁 Calculate Days to Target</button>
      </div>
      <div class="result" id="output"></div>
      <div class="menu">
          <button class="app-button ai-button" onclick="getAiInsights()">✨ Get AI Insights</button>
          <div class="loader" id="ai-loader"></div>
          <div class="result" id="ai-output" style="display: none;"></div>
      </div>
    </div>

    <div class="manual-container">
      <h3>🔧 Manual Controls & Current Stats</h3>
      <label for="manualGoldRate">Enter Gold Rate (₹ per gram):</label>
      <input type="number" id="manualGoldRate" placeholder="Enter current gold price...">
      <div class="highlight">
          💰 Current Balance: ₹<span id="balanceAmount">0.00</span>
          <span id="daily-change"></span>
      </div>
      <div class="current-grams">🥇 Current Gold Owned: <span id="currentGoldGrams" class="gold-text">...</span></div>
      <div class="next-installment-info">
          <h4>Next Installment Details</h4>
          <p><b>Date:</b> <span id="nextInstallmentDate"></span></p>
          <p><b>Amount:</b> <span id="nextInstallmentAmount"></span></p>
          <p><b>Money Increase:</b> <span class="highlight" id="moneyIncrease"></span></p>
          <p><b>Gold Increase:</b> <span class="gold-text" id="goldIncrease"></span></p>
      </div>
      <div class="countdown" id="countdown"></div>
      <div style="margin-top:10px" id="sinceLastProfit"></div>
    </div>
  </div>

  <!-- Other Modals -->
  <div id="transactions-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeTransactions()">&times;</span><h2>📜 Transaction History</h2><div id="transaction-list"></div></div></div>
  <div id="about-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeAbout()">&times;</span><h2>ℹ️ About & FAQ</h2><div id="about-content"><h3>How It Works</h3><p>This tool helps you track and forecast your digital gold investments. After setting your initial balance and daily SIP, you can see your current gold holdings, project future growth, and calculate how long it will take to reach your investment goals. Use the AI Insights button for a motivational analysis of your progress!</p><h3>Frequently Asked Questions</h3><h4>What is Digital Gold?</h4><p>Digital Gold is a way to invest in physical gold without having to physically hold it. Each unit of digital gold is backed by 24K physical gold stored in secure vaults.</p><h4>Why invest in a SIP?</h4><p>A Systematic Investment Plan (SIP) allows you to invest a fixed amount regularly, which helps in averaging out the cost of your investment over time and promotes disciplined saving.</p><h4>Is there a fee?</h4><p>This tracker is completely free to use. However, when buying digital gold on any platform, a 3% GST is typically charged on the transaction value.</p></div></div></div>
  <div id="contact-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeContact()">&times;</span><h3>📞 Contact</h3><p>Want a personalized tracker like this?</p><a href="https://wa.me/918590307346?text=Hi%20Sabith,%20I'm%20interested%20in%20the%20Digital%20Gold%20SIP%20Tracker." target="_blank">📱 Message on WhatsApp</a><p style="margin-top: 15px; font-size: 0.85em;">© 2025 Made by Sabith VY</p></div></div>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  
  <script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyA2a9HGBK1GN0_1fPHH-rpMNtoUbLS6DAo",
      authDomain: "digitalgoldtracker.firebaseapp.com",
      projectId: "digitalgoldtracker",
      storageBucket: "digitalgoldtracker.appspot.com",
      messagingSenderId: "763830342806",
      appId: "1:763830342806:web:80b099e1d57d7c740d5eb7"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- GLOBAL APP STATE ---
    let userState = { uid: null, name: '', balance: 0, dailySip: 0, transactions: [], isSetupComplete: false };
    let manualRate = null;
    let previousRate = null;
    let confirmationResult = null;
    let unverifiedUser = null; 
    let recaptchaVerifier = null;
    const DEFAULT_GOLD_RATE = 10216.00;
    const GST_MULTIPLIER = 0.97;

    // --- AUTHENTICATION & MODALS ---
    auth.onAuthStateChanged(async user => {
        if (user) {
            await checkAndCreateUserDocument(user);
            if (user.email && !user.emailVerified) {
                unverifiedUser = user;
                showAuth();
                document.getElementById('login-error').innerText = "Please verify your email to continue.";
                document.getElementById('resend-verification-btn').style.display = 'block';
                return;
            }
            await loadUserData(user.uid);
            document.getElementById('auth-modal').style.display = 'none';
            if(userState.isSetupComplete) {
                showApp();
            } else {
                document.getElementById('setup-modal').style.display = 'flex';
            }
        } else {
            showAuth();
        }
    });
    
    function toggleAuthView(isLogin) {
        const container = document.querySelector('.auth-flip-container');
        document.getElementById('login-error').innerText = '';
        document.getElementById('signup-error').innerText = '';
        document.getElementById('login-success').innerText = '';
        document.getElementById('resend-verification-btn').style.display = 'none';
        if (isLogin) {
            container.classList.remove('is-flipped');
        } else {
            container.classList.add('is-flipped');
        }
    }
    async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            document.getElementById('login-error').innerText = error.message;
        }
    }
    async function handleSignup() {
        const signupBtn = document.getElementById('signup-btn');
        const originalBtnText = signupBtn.innerHTML;
        signupBtn.disabled = true;
        signupBtn.innerHTML = 'Signing up...';

        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        if (!name) {
            document.getElementById('signup-error').innerText = "Please enter your name.";
            signupBtn.disabled = false;
            signupBtn.innerHTML = originalBtnText;
            return;
        }
        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            await userCredential.user.sendEmailVerification();
            await db.collection('users').doc(userCredential.user.uid).set({
                name: name,
                email: email,
                balance: 0,
                dailySip: 0,
                transactions: [],
                isSetupComplete: false
            });
            toggleAuthView(true);
            document.getElementById('login-success').innerText = "Signup successful! Please check your email (and spam folder) to verify your account.";
        } catch (error) {
            document.getElementById('signup-error').innerText = error.message;
        } finally {
            signupBtn.disabled = false;
            signupBtn.innerHTML = originalBtnText;
        }
    }
    async function handleResendVerification() {
        try {
            const userToSend = auth.currentUser || unverifiedUser;
            if (userToSend) {
                await userToSend.sendEmailVerification();
                document.getElementById('login-success').innerText = "A new verification email has been sent.";
            } else {
                document.getElementById('login-error').innerText = "Could not find user. Please try logging in again.";
            }
        } catch (error) {
            document.getElementById('login-error').innerText = error.message;
        }
    }
    async function handleLogout() { await auth.signOut(); window.location.reload(); }
    async function handleInitialSetup() {
        const balance = parseFloat(document.getElementById('initial-balance').value);
        const sip = parseFloat(document.getElementById('initial-sip').value);
        if (isNaN(balance) || isNaN(sip) || balance < 0 || sip <= 0) {
            alert("Please enter valid positive numbers for balance and SIP.");
            return;
        }
        userState.balance = balance;
        userState.dailySip = sip;
        userState.isSetupComplete = true;
        await saveUserData();
        document.getElementById('setup-modal').style.display = 'none';
        showApp();
    }
    function openForgotPassword() {
        document.getElementById('auth-modal').style.display = 'none';
        document.getElementById('forgot-password-modal').style.display = 'flex';
    }
    function closeForgotPassword() {
        document.getElementById('forgot-password-modal').style.display = 'none';
        document.getElementById('auth-modal').style.display = 'flex';
        document.getElementById('reset-error').innerText = '';
        document.getElementById('reset-success').innerText = '';
    }
    async function handleForgotPassword() {
        const email = document.getElementById('reset-email').value;
        const errorEl = document.getElementById('reset-error');
        const successEl = document.getElementById('reset-success');
        errorEl.innerText = '';
        successEl.innerText = '';
        if (!email) {
            errorEl.innerText = 'Please enter your email address.';
            return;
        }
        try {
            await auth.sendPasswordResetEmail(email);
            successEl.innerText = 'Password reset email sent! Please check your inbox.';
        } catch (error) {
            errorEl.innerText = error.message;
        }
    }
    function showApp() {
        document.getElementById('auth-modal').style.display = 'none';
        document.querySelector('.animated-background').classList.add('app-view');
        document.getElementById('app-content').style.display = 'block';
        runAppInitializers();
    }
    function showAuth() {
        document.querySelector('.animated-background').classList.remove('app-view');
        document.getElementById('app-content').style.display = 'none';
        document.getElementById('auth-modal').style.display = 'flex';
    }
    async function loadUserData(uid) {
        const userRef = db.collection('users').doc(uid);
        const doc = await userRef.get();
        if (doc.exists) {
            const data = doc.data();
            userState = { ...userState, ...data, uid };
        }
    }
    async function saveUserData() {
        if (!userState.uid) return;
        const { uid, ...dataToSave } = userState;
        await db.collection('users').doc(userState.uid).set(dataToSave, { merge: true });
    }
    function runAppInitializers() {
        document.getElementById('welcome-message').innerText = `Welcome, ${userState.name}`;
        document.getElementById('balanceAmount').innerText = userState.balance.toFixed(2);
        document.getElementById('daily-sip-display').innerHTML = `📥 Daily SIP: ₹${userState.dailySip.toFixed(2)} (₹${(userState.dailySip * GST_MULTIPLIER).toFixed(2)} after GST)`;
        setInterval(updateClock, 1000);
        updateClock();
        fetchDigitalGoldRate();
        updateCurrentStats();
        updateProfitLossIndicator();
        renderTransactions();
        document.getElementById('output').innerText = 'Please use the controls above to see calculations.';
        if (typeof flatpickr === "function") {
            flatpickr("#targetDate", { altInput: true, altFormat: "F j, Y", dateFormat: "Y-m-d", minDate: "today" });
        }
    }
    function updateCurrentStats() {
        const goldPrice = manualRate !== null ? manualRate : DEFAULT_GOLD_RATE;
        const gstAdjustedInstallment = userState.dailySip * GST_MULTIPLIER;
        const currentGrams = userState.balance > 0 ? userState.balance / goldPrice : 0;
        document.getElementById('currentGoldGrams').innerText = `${currentGrams.toFixed(5)} g`;
        const goldIncrease = gstAdjustedInstallment / goldPrice;
        document.getElementById('nextInstallmentDate').innerText = new Date(new Date().setDate(new Date().getDate() + 1)).toLocaleDateString('en-GB');
        document.getElementById('nextInstallmentAmount').innerText = `₹${userState.dailySip.toFixed(2)}`;
        document.getElementById('moneyIncrease').innerText = `+₹${gstAdjustedInstallment.toFixed(2)}`;
        document.getElementById('goldIncrease').innerText = `+${goldIncrease.toFixed(5)} g`;
    }
    function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); }
    function openTransactions() { document.getElementById('transactions-modal').style.display = 'block'; toggleMenu(); }
    function closeTransactions() { document.getElementById('transactions-modal').style.display = 'none'; }
    function openContact() { document.getElementById('contact-modal').style.display = 'block'; toggleMenu(); }
    function closeContact() { document.getElementById('contact-modal').style.display = 'none'; }
    function openAbout() { document.getElementById('about-modal').style.display = 'block'; toggleMenu(); }
    function closeAbout() { document.getElementById('about-modal').style.display = 'none'; }
    function updateClock() {
      const now = new Date();
      const options = { timeZone: 'Asia/Kolkata', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
      document.getElementById('clock').innerText = now.toLocaleTimeString('en-IN', options);
    }
    function redirectToGoldSite() { window.open('https://gadgets360.com/finance/digital-gold-price-in-india', '_blank'); }
    function fetchDigitalGoldRate() {
      const rate = manualRate !== null ? manualRate : DEFAULT_GOLD_RATE;
      document.getElementById('goldRateDisplay').innerText = `🌟 Current Gold Rate: ₹${rate.toFixed(2)} / gram`;
      return rate;
    }
    function updateProfitLossIndicator() {
        const currentRate = manualRate !== null ? manualRate : DEFAULT_GOLD_RATE;
        const prevRate = previousRate || currentRate;
        const currentGrams = userState.balance > 0 ? userState.balance / prevRate : 0;
        const oldValue = currentGrams * prevRate;
        const newValue = currentGrams * currentRate;
        const change = newValue - oldValue;
        const percentageChange = (oldValue > 0) ? (change / oldValue) * 100 : 0;
        const indicatorEl = document.getElementById('daily-change');
        if (Math.abs(change) < 0.01) {
            indicatorEl.innerHTML = '';
            return;
        }
        const arrow = change > 0 ? '↑' : '↓';
        const colorClass = change > 0 ? 'profit' : 'loss';
        indicatorEl.className = colorClass;
        indicatorEl.innerHTML = `${arrow} ₹${Math.abs(change).toFixed(2)} (${Math.abs(percentageChange).toFixed(2)}%)`;
    }
    function applyManualGoldRate() {
      const manualInput = parseFloat(document.getElementById('manualGoldRate').value);
      if (!isNaN(manualInput) && manualInput > 0) {
        previousRate = manualRate || DEFAULT_GOLD_RATE;
        manualRate = manualInput;
        const profit = manualRate - previousRate;
        const msg = `📈 Change vs Previous: ₹${profit.toFixed(2)} (${profit >= 0 ? 'Profit' : 'Loss'})`;
        document.getElementById('sinceLastProfit').innerText = msg;
        fetchDigitalGoldRate();
        updateCurrentStats();
        updateProfitLossIndicator();
      } else {
        alert("Please enter a valid gold rate.");
      }
    }
    function renderTransactions() {
        const listEl = document.getElementById('transaction-list');
        listEl.innerHTML = ''; // Clear previous list
        const dummyTransactions = [
            { date: '24 Jul 2025', amount: userState.dailySip, status: 'Success' },
            { date: '23 Jul 2025', amount: userState.dailySip, status: 'Success' },
        ];
        if (dummyTransactions.length === 0) {
            listEl.innerHTML = '<p>No transactions yet.</p>';
            return;
        }
        for (const tx of dummyTransactions) {
            const gst = tx.amount * (1 - GST_MULTIPLIER);
            const credited = tx.amount - gst;
            const item = document.createElement('div');
            item.className = 'transaction-item';
            item.innerHTML = `
                <div>
                    <div class="amount">₹${tx.amount.toFixed(2)}</div>
                    <div class="date">Credited: ₹${credited.toFixed(2)} (GST: ₹${gst.toFixed(2)}) • ${tx.date}</div>
                </div>
                <div class="status ${tx.status.toLowerCase()}">${tx.status}</div>
            `;
            listEl.appendChild(item);
        }
    }
    function calculateGrowthFromDate() {
      const goldPrice = fetchDigitalGoldRate();
      const dailySip = userState.dailySip * GST_MULTIPLIER;
      const today = new Date();
      const flatpickrInstance = document.getElementById('targetDate')._flatpickr;
      if (!flatpickrInstance || flatpickrInstance.selectedDates.length === 0) {
          document.getElementById('output').innerText = 'Please select a valid future date.';
          return;
      }
      const targetDate = new Date(flatpickrInstance.selectedDates[0]);
      if (isNaN(targetDate.getTime()) || targetDate <= today) {
        document.getElementById('output').innerText = 'Please select a valid future date.';
        return;
      }
      const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
      const totalInvestment = userState.balance + (dailySip * diffDays);
      const totalGoldOwned = totalInvestment / goldPrice;
      const estimatedValue = totalGoldOwned * goldPrice;
      document.getElementById('output').innerHTML = `
        <b>Forecast for ${targetDate.toLocaleDateString()}:</b><br><br>
        - Days Remaining: <b>${diffDays}</b><br>
        - Total Invested: <b>₹${totalInvestment.toFixed(2)}</b><br>
        - Est. Gold Owned: <b>${totalGoldOwned.toFixed(5)} g</b><br>
        - Est. Portfolio Value: <b class="highlight">₹${estimatedValue.toFixed(2)}</b>`;
    }
    function calculateToReachTargetGrams() {
      const goldPrice = fetchDigitalGoldRate();
      const dailySip = userState.dailySip * GST_MULTIPLIER;
      const targetGold = parseFloat(document.getElementById('targetGoldGrams').value);
      if (isNaN(targetGold) || targetGold <= 0) {
        document.getElementById('output').innerText = 'Please enter a valid target weight in grams.';
        return;
      }
      const requiredInvestment = targetGold * goldPrice;
      const remainingInvestment = Math.max(0, requiredInvestment - userState.balance);
      const daysNeeded = Math.ceil(remainingInvestment / dailySip);
      const finalInvestmentValue = userState.balance + (daysNeeded * dailySip);
      const futureDate = new Date();
      futureDate.setDate(futureDate.getDate() + daysNeeded);
      document.getElementById('output').innerHTML = `
        <b>Path to ${targetGold}g of Gold:</b><br><br>
        - Est. Days Needed: <b>${daysNeeded}</b><br>
        - Est. Completion Date: <b>${futureDate.toLocaleDateString()}</b><br>
        - Amount to Invest: <b>₹${remainingInvestment.toFixed(2)}</b><br>
        - Final Portfolio Value: <b class="highlight">₹${finalInvestmentValue.toFixed(2)}</b>`;
    }
    async function getAiInsights() {
        const aiOutput = document.getElementById('ai-output');
        const loader = document.getElementById('ai-loader');
        loader.style.display = 'block';
        aiOutput.style.display = 'none';
        aiOutput.innerHTML = '';
        const goldPrice = fetchDigitalGoldRate();
        const targetGold = parseFloat(document.getElementById('targetGoldGrams').value) || 1;
        const prompt = `You are a friendly and encouraging financial assistant. Provide a short, motivational analysis of a user's Digital Gold SIP based on this data:
- Balance: ₹${userState.balance.toFixed(2)}
- Daily SIP: ₹${(userState.dailySip * GST_MULTIPLIER).toFixed(2)}
- Target: ${targetGold}g
- Gold Price: ₹${goldPrice.toFixed(2)}/g
Keep it positive and encouraging. Do not give financial advice. Start with 'Here are some thoughts on your progress:'`;
        try {
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; // This should be your Gemini API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) { throw new Error(`API request failed with status ${response.status}`); }
            const result = await response.json();
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                aiOutput.innerHTML = text.replace(/\n/g, '<br>');
            } else { throw new Error("Invalid response structure from API."); }
        } catch (error) {
            console.error("Error fetching AI insights:", error);
            aiOutput.innerText = "Sorry, I couldn't fetch insights at the moment. Please try again later.";
        } finally {
            loader.style.display = 'none';
            aiOutput.style.display = 'block';
        }
    }

    // --- PHONE AUTH FUNCTIONS ---
    function togglePhoneLogin(button) {
        const emailFields = document.getElementById('email-login-fields');
        const phoneFields = document.getElementById('phone-login-fields');
        if (phoneFields.style.display === 'none') {
            emailFields.style.display = 'none';
            phoneFields.style.display = 'block';
            button.innerText = 'Sign in with Email';
            if (!recaptchaVerifier) {
                recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => { /* reCAPTCHA solved */ }
                });
                recaptchaVerifier.render();
            }
        } else {
            emailFields.style.display = 'block';
            phoneFields.style.display = 'none';
            button.innerText = 'Sign in with Phone';
        }
    }

    function sendOtp() {
        const phoneNumber = document.getElementById('phone-number').value;
        const appVerifier = recaptchaVerifier;
        auth.signInWithPhoneNumber(phoneNumber, appVerifier)
            .then((result) => {
                confirmationResult = result;
                document.getElementById('otp-group').style.display = 'block';
                document.getElementById('verify-otp-btn').style.display = 'block';
                document.getElementById('login-success').innerText = 'OTP sent successfully!';
                document.getElementById('login-error').innerText = '';
            }).catch((error) => {
                document.getElementById('login-error').innerText = 'Error sending OTP: ' + error.message;
                if (typeof grecaptcha !== 'undefined' && recaptchaVerifier) {
                    try {
                        grecaptcha.reset(recaptchaVerifier.widgetId);
                    } catch (e) {
                       // Can ignore reset errors
                    }
                }
            });
    }

    function verifyOtp() {
        const code = document.getElementById('otp').value;
        if (!confirmationResult) {
            document.getElementById('login-error').innerText = 'Please send an OTP first.';
            return;
        }
        confirmationResult.confirm(code).then((result) => {
            // User signed in successfully. onAuthStateChanged will handle the rest.
        }).catch((error) => {
            document.getElementById('login-error').innerText = 'Invalid OTP. Please try again.';
        });
    }

    async function checkAndCreateUserDocument(user) {
        const userRef = db.collection('users').doc(user.uid);
        const doc = await userRef.get();
        if (!doc.exists) {
            // This is a new user (likely from phone auth)
            await userRef.set({
                name: user.phoneNumber || 'New User', // Use phone number as a placeholder name
                email: user.email || null,
                phone: user.phoneNumber,
                balance: 0,
                dailySip: 0,
                transactions: [],
                isSetupComplete: false
            });
        }
    }
  </script>
</body>
</html>
